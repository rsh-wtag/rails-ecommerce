<% if current_user&.admin? %>
  <div class="mb-3 d-flex">
    <%= link_to 'Edit Product', edit_product_path(@product), class: 'btn btn-warning me-2' %>
    <%= button_to 'Delete Product', product_path(@product), method: :delete, data: { confirm: 'Are you sure you want to delete this product?' }, class: 'btn btn-danger' %>
  </div>
<% end %>
<div class="container mt-5">
  <div class="row">
    <div class="col-lg-5">
      <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators position-relative" style="bottom: -30px;">
          <% @product.images.each_with_index do |image, index| %>
            <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="<%= index %>" 
                    class="<%= 'active' if index.zero? %>" aria-current="<%= 'true' if index.zero? %>"
                    style="background-color: rgba(0, 0, 0, 0.5); border: 1px solid #fff; width: 12px; height: 12px; border-radius: 50%;">
            </button>
          <% end %>
        </div>
        <div class="carousel-inner">
          <% @product.images.each_with_index do |image, index| %>
            <div class="carousel-item <%= 'active' if index.zero? %>">
              <%= image_tag url_for(image), class: 'd-block w-100', alt: "Product Image" %>
            </div>
          <% end %>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      <div class="mt-3 d-flex flex-wrap">
        <% @product.images.each do |image| %>
          <%= image_tag url_for(image), class: 'img-thumbnail me-2 mb-2', style: 'width: 80px; height: 80px;', alt: 'Thumbnail Image' %>
        <% end %>
      </div>
    </div>
    <div class="col-lg-7">
      <h1 class="display-6 mb-4 extra-bold-heading"><%= @product.name %></h1>
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9"><%= simple_format(@product.description) %></dd>
            <dt class="col-sm-3">Price</dt>
            <dd class="col-sm-9 text-success"><%= number_to_currency(@product.price, unit: "", format: "%n BDT") %></dd>
            <dt class="col-sm-3">Stock Quantity</dt>
            <dd class="col-sm-9"><%= @product.stock_quantity %></dd>
            <dt class="col-sm-3">SKU</dt>
            <dd class="col-sm-9 text-muted"><%= @product.SKU %></dd>
            <dt class="col-sm-3">Rating</dt>
            <dd class="col-sm-9">
              <% average_rating = @product.reviews.average(:rating).to_f %>
              <% full_stars = average_rating.floor %>
              <% has_half_star = average_rating - full_stars >= 0.5 %>
              <% empty_stars = 5 - full_stars - (has_half_star ? 1 : 0) %>
              <% full_stars.times do %>
                <i class="fas fa-star" style="color: gold;"></i>
              <% end %>
              <% if has_half_star %>
                <i class="fas fa-star-half-alt" style="color: gold;"></i>
              <% end %>
              <% empty_stars.times do %>
                <i class="far fa-star" style="color: gold;"></i>
              <% end %>
              <% review_count = @product.reviews.count %>
              <% if review_count > 0 %>
                <span class="text-muted">(<%= review_count %> review<%= 's' if review_count > 1 %>)</span>
              <% else %>
                <span class="text-muted">(No reviews yet)</span>
              <% end %>
            </dd>
            <% unless current_user&.admin? %>
              <div class="mt-4">
                <%= form_with(model: CartItem.new, url: cart_items_path, method: :post, local: true) do |form| %>
                  <%= form.hidden_field :product_id, value: @product.id %>
                  <div class="mb-3">
                    <%= form.label :quantity, "Quantity", class: 'form-label' %>
                    <%= form.number_field :quantity, value: 1, min: 1, class: 'form-control' %>
                  </div>
                  <div>
                    <%= form.submit "Add to Cart", class: 'btn btn-primary' %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </div>
  <% if current_user && !current_user.admin? %>
    <div class="mt-4">
      <h3>Add a Review</h3>
      <%= form_with(model: [ @product, @product.reviews.build ], local: true) do |form| %>
        <div class="mb-3">
          <%= form.label :rating, "Rating (1-5)", class: 'form-label' %>
          <%= form.number_field :rating, min: 1, max: 5, class: 'form-control', required: true %>
        </div>
        <div class="mb-3">
          <%= form.label :comment, "Comment", class: 'form-label' %>
          <%= form.text_area :comment, rows: 4, class: 'form-control', required: true %>
        </div>
        <div>
          <%= form.submit "Submit Review", class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  <% end %>
  <div class="mt-5">
    <h3>Reviews</h3>
    <% @product.reviews.each do |review| %>
      <% if review.rating.present? && review.user.present? %>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title d-flex align-items-center">
              <span class="me-2 text-primary fw-bold"><%= review.user.name %></span>
              <span class="text-muted">-</span>
              <span class="ms-2 d-flex align-items-center">
                <%= review.rating %>
                <span class="ms-1 text-warning">&#9733;</span>
              </span>
            </h5>
            <p class="card-text"><%= simple_format(review.comment) %></p>
            <div class="d-flex justify-content-start">
              <% if current_user == review.user %>
                <%= link_to 'Edit', edit_product_review_path(@product, review), class: 'btn btn-warning btn-sm me-2' %>
              <% end %>
              <% if current_user&.admin? || current_user == review.user %>
                <%= button_to product_review_path(@product, review), method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger btn-sm' do %>
                  <i class="bi bi-trash"></i> Delete
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
